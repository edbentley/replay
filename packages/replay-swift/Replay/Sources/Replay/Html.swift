// Swift 5.3 will support Package resources like a JS file
// https://github.com/apple/swift-evolution/blob/master/proposals/0271-package-manager-resources.md
// Until then, we'll just copy renderCanvas.js as a string here

let replayRenderCanvasHtmlString = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
      <title>Replay</title>
      <style>
        html, body {
          margin: 0;
          height: 100%;
          width: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
        }
      </style>
    </head>
    <body>
    <script>
      window.onerror = e => { window.webkit.messageHandlers.error.postMessage(e.message || e); };
    
      \(replayRenderCanvasJsString)
      renderCanvas.run();
    </script>
    </body>
    </html>
"""

let replayRenderCanvasJsString = """
var renderCanvas=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";function i(e){var t,n,i;return{x:e.x||0,y:e.y||0,rotation:e.rotation||0,opacity:Math.min(1,Math.max(0,null!==(t=e.opacity)&&void 0!==t?t:1)),scaleX:null!==(n=e.scaleX)&&void 0!==n?n:1,scaleY:null!==(i=e.scaleY)&&void 0!==i?i:1,anchorX:e.anchorX||0,anchorY:e.anchorY||0,mask:e.mask||null}}function r(e,t,n,o,a,d,l,u,p,h){const f=i(t);f.opacity*=u;const{nativeSpriteMap:g,nativeSpriteUtils:m}=h,w=e=>{const t=o(e);return function(e){const t=Math.PI/180,n=-(e.rotation||0)*t;return({x:t,y:i})=>{const r=t-e.x,o=i-e.y,s=r*Math.cos(n)+o*Math.sin(n),a=-r*Math.sin(n)+o*Math.cos(n),c=s/e.scaleX,d=a/e.scaleY;return{x:c+e.anchorX,y:d+e.anchorY}}}(f)(t)},v=n(w),y=e.getSprites(t,v,a,d,l),M=[],b=y.map(t=>{if(!t)return t;if("native"===t.type){M.push(t.props.id);const n=g[t.name];if(!n)throw Error(`Cannot find Native Sprite "${t.name}"`);let i=e.childContainers[t.props.id];return i&&"native"===i.type||(i={type:"native",state:n.create({props:t.props,parentGlobalId:p,getState:()=>i.state,updateState:e=>{i.state={...i.state,...e}},utils:m}),cleanup:n.cleanup},e.childContainers[t.props.id]=i),i.state=n.loop({props:t.props,state:i.state,parentGlobalId:p,utils:m}),m.didResize=!1,null}if("custom"===t.type){M.push(t.props.id);let i=!1,o=e.childContainers[t.props.id];return o&&"custom"===o.type||(i=!0,o=s(t,v,e.prevTime),e.childContainers[t.props.id]=o),r(o,t.props,n,w,i,d,l,f.opacity,`${p}--${t.props.id}`,h)}return t}).filter(c),P=e=>{Object.keys(e).forEach(t=>{if(!M.includes(t)){const n=e[t];"native"===n.type?n.cleanup({state:n.state,parentGlobalId:p}):P(n.childContainers),delete e[t]}})};return P(e.childContainers),{id:t.id,baseProps:f,textures:b}}n.r(t),n.d(t,"run",(function(){return k}));const o=1/60*1e3;function s(e,t,n){const{spriteObj:i,props:r}=e,o=[],s=e=>{o.push(e)};let a;return i.init&&(a=i.init({props:r,device:t,updateState:s})),{type:"custom",state:a,childContainers:{},prevTime:n,currentLag:0,getSprites(e,t,n,r,a){const c=()=>{this.state=o.reduce((e,t)=>t(e),this.state),o.length=0};c(),!n&&i.loop&&(this.state=i.loop({props:e,state:this.state,device:t,updateState:s})),c();let d=i[r];d||(d="renderPXL"===r&&i.renderXL?i.renderXL:i.render);const l=d({props:e,state:this.state,device:t,updateState:s,extrapolateFactor:a});return c(),l}}}function a(e,t){const n=e.deviceHeight>e.deviceWidth;let i,r=!1;"portrait"in t?(i=n?t.portrait:t.landscape,r=!0):i=t;return i.minHeightXL&&e.deviceHeight>=i.minHeightXL||i.minWidthXL&&e.deviceWidth>=i.minWidthXL?r&&n?"renderPXL":"renderXL":r&&n?"renderP":"render"}function c(e){return null!==e}let d={keysDown:{},keysJustPressed:{},pointer:{pressed:!1,numberPressed:0,justPressed:!1,justReleased:!1,x:0,y:0}},l=[];function u(e){return function(e,t){const n=e(t.pointer);return{...t,pointer:{...t.pointer,x:n.x,y:n.y}}}(e,d)}function p(e){["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "].includes(e.key)&&!(e.target instanceof HTMLTextAreaElement||e.target instanceof HTMLInputElement)&&e.preventDefault(),d.keysDown[e.key]=!0,d.keysJustPressed[e.key]=!0}function h(e){delete d.keysDown[e.key]}function f(e){l=l.filter(t=>t!==e),d.pointer.numberPressed=l.length,0===l.length&&(d.pointer.justPressed=!1,d.pointer.pressed=!1)}function g(){d={keysDown:d.keysDown,keysJustPressed:{},pointer:{...d.pointer,justPressed:!1,justReleased:!1}}}function m(e,{width:t,height:n,widthMargin:i,heightMargin:r,deviceWidth:o,deviceHeight:s},a,c){e.save();const d=Math.min(o/t,s/n),l=t+2*i,u=n+2*r;return e.translate(o/2,s/2),e.scale(d,d),{scale:d,render:t=>{e.clearRect(-o/2/d,-s/2/d,o/d,s/d),e.fillStyle="white",e.fillRect(-l/2,-u/2,l,u),function e(t,n,i,r){const{baseProps:o,textures:s}=t;n.save(),v(n,o),s.forEach(t=>{if("type"in t){const e=y(n);return n.save(),v(n,t.props,o.opacity),function(e,t,n,i){switch(e.type){case"text":return t.text(e.props.font||i,e.props.text,e.props.align,e.props.color),0;case"circle":return t.circle(e.props.radius,e.props.color),0;case"rectangle":return t.rectangle(e.props.width,e.props.height,e.props.color),0;case"line":return t.line(e.props.path,e.props.thickness,e.props.color),0;case"image":const r=n[e.props.fileName];if(!r)throw Error(`Cannot find image file "${e.props.fileName}"`);return t.image(r,e.props.width,e.props.height),0;case"spriteSheet":t.spriteSheet(n[e.props.fileName],e.props.columns,e.props.rows,e.props.index,e.props.width,e.props.height)}}(t,e,i,r),void n.restore()}e(t,n,i,r)}),n.restore()}(t,e,a,c)}}}const w=Math.PI/180,v=(e,t,n=1)=>{const{x:i,y:r,rotation:o,scaleX:s,scaleY:a,anchorX:c,anchorY:d,opacity:l}=t;e.translate(i,-r),e.rotate(o*w),e.scale(s,a),e.translate(-c,d),e.globalAlpha=l*n,function(e,t){if(!t)return 0;switch(t.type){case"lineMask":{const[[n,i],...r]=t.path;return e.beginPath(),e.moveTo(n,-i),r.forEach(([t,n])=>{e.lineTo(t,-n)}),e.clip(),0}case"circleMask":return e.beginPath(),e.arc(t.x,-t.y,Math.round(t.radius),0,2*Math.PI),e.clip(),0;case"rectangleMask":e.beginPath(),e.rect(t.x-t.width/2,-t.y-t.height/2,t.width,t.height),e.clip()}}(e,t.mask)};const y=e=>({circle(t,n){e.beginPath(),e.arc(0,0,Math.round(t),0,2*Math.PI),e.fillStyle=n,e.fill(),e.closePath()},rectangle(t,n,i){e.fillStyle=i,e.fillRect(-t/2,-n/2,t,n),e.closePath()},line(t,n,i){if(t.length<2)return;const[[r,o],...s]=t;e.strokeStyle=i,e.lineWidth=n,e.beginPath(),e.moveTo(r,-o),s.forEach(([t,n])=>{e.lineTo(t,-n)}),e.stroke()},text(t,n,i,r){const o=`${t.size}px ${t.name}`;e.font=o,e.textBaseline="middle",e.textAlign=i,e.fillStyle=r,e.fillText(n,0,0)},image(t,n,i){e.drawImage(t,-n/2,-i/2,n,i)},spriteSheet(t,n,i,r,o,s){const a=t.width/n,c=t.height/i,d=r%n,l=Math.floor(r/n)%i;e.drawImage(t,d*a,l*c,a,c,-o/2,-s/2,o,s)}});let M;function b(e,t,n,i){let r;if("portrait"in i){r=t>e?i.portrait:i.landscape}else r=i;const{width:o,height:s,maxWidthMargin:a=0,maxHeightMargin:c=0}=r;if("game-coords"===n)return{width:o,height:s,widthMargin:0,heightMargin:0,deviceWidth:o,deviceHeight:s};const d=o/s;if(d>e/t){const n=e,i=n/d,r=i/s*c,a=Math.min(t,i+2*r);return{width:o,height:s,widthMargin:0,heightMargin:(a-i)/2*(s/i),deviceWidth:n,deviceHeight:a}}{const n=t,i=n*d,r=i/o*a,c=Math.min(e,i+2*r);return{width:o,height:s,widthMargin:(c-i)/2*(o/i),heightMargin:0,deviceWidth:c,deviceHeight:n}}}function P(){const e={};return{start:(t,n)=>{const i=window.setTimeout(()=>{delete e[r],t()},n),r=String(i);return e[r]={timeoutId:i,callback:t,timeStartedMs:Date.now(),timeRemainingMs:n,isPaused:!1},r},pause:t=>{const n=e[t];if(!n||n.isPaused)return;const i=Date.now()-n.timeStartedMs;n.timeRemainingMs-=i,n.isPaused=!0,window.clearTimeout(n.timeoutId)},resume:t=>{const n=e[t];if(!n||!n.isPaused)return;n.timeStartedMs=Date.now(),n.isPaused=!1;const i=window.setTimeout(()=>{delete e[t],n.callback()},n.timeRemainingMs);n.timeoutId=i},cancel:t=>{const n=e[t];n&&(window.clearTimeout(n.timeoutId),delete e[t])}}}function x(e){return t=>{function n(n){let i=e[t];if(!i)throw Error("Cannot find audio file "+t);return n&&!i.paused&&(i=new Audio(t)),i}return{getPosition:()=>n(!1).currentTime,play:(e,t)=>{const i=n(!0);i.play(),void 0!==e&&(i.currentTime=e),t&&(i.loop=!0)},pause:()=>{n(!1).pause()}}}}function L(){if("ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch)return!0;return window.matchMedia("(touch-enabled),(-webkit-touch-enabled),(-moz-touch-enabled),(-o-touch-enabled),(-ms-touch-enabled)").matches}const S={name:"sans-serif",size:12};function T(e,{loadingTextures:t=[],assets:n={},dimensions:c="game-coords",nativeSpriteMap:u={},canvas:w,windowSize:v}){var y;const P=w||document.createElement("canvas");w||document.body.appendChild(P);const x=P.getContext("2d",{alpha:!1});new(window.AudioContext||window.webkitAudioContext);let L=!0;let T,k,j,I,O,X;document.addEventListener("keydown",e=>{L&&p(e)},!1),document.addEventListener("keyup",e=>{L&&h(e)},!1),window.addEventListener("resize",D,!1);const C={didResize:!1,scale:1,gameXToPlatformX:e=>e,gameYToPlatformY:e=>e};function D(t){if(T&&(x.restore(),document.removeEventListener("pointerdown",k),document.removeEventListener("pointermove",j),document.removeEventListener("pointerup",I),document.removeEventListener("pointerout",O),!0===t))return;const n=function(e,t,n,i){const r=b(e,t,n,i);return M=r,r}((null==v?void 0:v.width)||window.innerWidth,(null==v?void 0:v.height)||window.innerHeight,c,e.props.size);P.width=n.deviceWidth,P.height=n.deviceHeight;const i=e.props.defaultFont||S,r=m(x,n,z,i);X=r.scale,W.ref=r.render,C.gameXToPlatformX=(({canvasOffsetLeft:e,widthMargin:t,scale:n,width:i})=>r=>e+n*(r+i/2+t))({canvasOffsetLeft:P.offsetLeft,width:n.width,widthMargin:n.widthMargin,scale:X}),C.gameYToPlatformY=(({canvasOffsetTop:e,heightMargin:t,scale:n,height:i})=>r=>e-n*(r-i/2-t))({canvasOffsetTop:P.offsetTop,height:n.height,heightMargin:n.heightMargin,scale:X}),C.didResize=!0,C.scale=X;const o=(({canvasOffsetLeft:e,widthMargin:t,scale:n,width:i})=>r=>(r.clientX-e)/n-t-i/2)({canvasOffsetLeft:P.offsetLeft,width:n.width,widthMargin:n.widthMargin,scale:X}),s=(({canvasOffsetTop:e,heightMargin:t,scale:n,height:i})=>r=>-(r.clientY-e)/n+t+i/2)({canvasOffsetTop:P.offsetTop,height:n.height,heightMargin:n.heightMargin,scale:X}),a=(e,t)=>e>n.width/2+n.widthMargin||e<-n.width/2-n.widthMargin||t>n.height/2+n.heightMargin||t<-n.height/2-n.heightMargin;k=e=>{const t=o(e),n=s(e);a(t,n)?L=!1:(L=!0,function(e,t,n){l.includes(n)||(l=[...l,n]),d.pointer.pressed=!0,d.pointer.numberPressed=l.length,d.pointer.justPressed=!0,d.pointer.x=e,d.pointer.y=t}(t,n,e.pointerId))},j=e=>{const t=o(e),n=s(e);a(t,n)||function(e,t){d.pointer.x=e,d.pointer.y=t}(t,n)},I=e=>{const t=o(e),n=s(e);a(t,n)?f(e.pointerId):function(e,t,n){l=l.filter(e=>e!==n),0===l.length&&(d.pointer.justPressed=!1,d.pointer.pressed=!1),d.pointer.numberPressed=l.length,d.pointer.justReleased=!0,d.pointer.x=e,d.pointer.y=t}(t,n,e.pointerId)},O=e=>{f(e.pointerId)},document.addEventListener("pointerdown",k,!1),document.addEventListener("pointermove",j,!1),document.addEventListener("pointerup",I,!1),document.addEventListener("pointerout",O,!1),T=n}const H={},z={},R={getGetDevice:E(H,b((null==v?void 0:v.width)||window.innerWidth,(null==v?void 0:v.height)||window.innerHeight,c,e.props.size))},W={ref:null};D();let Y=!1;null===(y=W.ref)||void 0===y||y.call(W,{id:"Loading",baseProps:i({}),textures:t});return{cleanup:function(){P.width=P.width,w||document.body.removeChild(P),Y=!0,document.removeEventListener("keydown",p,!1),document.removeEventListener("keyup",h,!1),window.removeEventListener("resize",D,!1),D(!0)},loadPromise:(async()=>{const e=[];(n.audioFileNames||[]).forEach(t=>{H[t]=new Audio(t),e.push(new Promise((e,n)=>{H[t].addEventListener("canplaythrough",e),H[t].addEventListener("error",n)})),H[t].load()}),(n.imageFileNames||[]).forEach(t=>{z[t]=new Image,e.push(new Promise((e,n)=>{z[t].addEventListener("load",e),z[t].addEventListener("error",n),z[t].src=t}))}),await Promise.all(e)})().then(()=>{const t=()=>{document.removeEventListener("keydown",t,!1),document.removeEventListener("pointerdown",t,!1),Object.values(H).forEach(e=>{e.muted=!0,e.play().then(()=>{e.pause(),e.muted=!1})})};document.addEventListener("keydown",t,!1),document.addEventListener("pointerdown",t,!1);const{initTextures:n,getNextFrameTextures:i}=function(e,t,n,i){const c=({x:e,y:t})=>({x:e,y:t}),d=e.getGetDevice(),l=d(c),u=s(n,d(c),0),p=i||n.props.size,h=a(l.size,p);let f=0,g=0,m=r(u,n.props,d,c,!0,h,0,1,n.props.id,t);return{initTextures:m,getNextFrameTextures(i,s){const d=i-f;for(f=i,g+=d;g>=o;){g-=o;const i=g/o,d=e.getGetDevice(),l=a(d(c).size,p);m=r(u,n.props,d,c,!1,l,i,1,n.props.id,t),s()}return m}}}(R,{nativeSpriteMap:u,nativeSpriteUtils:C},e);let c=null;!function e(t){var n;null===(n=W.ref)||void 0===n||n.call(W,t),window.requestAnimationFrame(t=>{Y||(null===c&&(c=t-1/60),e(i(t-c,g)))})}(n)}),audioElements:H}}function E(e,t){const n={isTouchScreen:L(),log:console.log,random:Math.random,timer:P(),audio:x(e),network:{get:(e,t)=>{fetch(e).then(e=>e.json()).then(t)},post:(e,t,n)=>{fetch(e,{method:"POST",body:JSON.stringify(t)}).then(e=>e.json()).then(n)},put:(e,t,n)=>{fetch(e,{method:"PUT",body:JSON.stringify(t)}).then(e=>e.json()).then(n)},delete:(e,t)=>{fetch(e,{method:"DELETE"}).then(e=>e.json()).then(t)}},storage:{getStore:()=>{var e;const t={};for(let n=0;n<localStorage.length;n++){const i=localStorage.key(n);i&&(t[i]=null!==(e=localStorage.getItem(i))&&void 0!==e?e:void 0)}return t},setStore:e=>{Object.entries(e).forEach(([e,t])=>{void 0===t?localStorage.removeItem(e):localStorage.setItem(e,t)})}},alert:{ok:(e,t)=>{alert(e),null==t||t()},okCancel:(e,t)=>{t(confirm(e))}},clipboard:{copy:(e,t)=>{navigator.clipboard?navigator.clipboard.writeText(e).then(()=>{t()}).catch(e=>{t(e)}):t(new Error(window.isSecureContext?"Couldn't access clipboard":"Clipboard only available on HTTPS or localhost"))}}};return()=>{const e={...n,size:M||t,now:()=>new Date};return t=>({...e,inputs:u(t)})}}function k(){const{loadPromise:e}=T(game.Game(game.gameProps),game.options);e.then(()=>{webkit.messageHandlers.didLoad.postMessage("")})}console.log=e=>{webkit.messageHandlers.consoleLog.postMessage(e)}}]);
"""
