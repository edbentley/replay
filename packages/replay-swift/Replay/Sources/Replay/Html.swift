// Swift 5.3 will support Package resources like a JS file
// https://github.com/apple/swift-evolution/blob/master/proposals/0271-package-manager-resources.md
// Until then, we'll just copy renderCanvas.js as a string here

let replayRenderCanvasHtmlString = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
      <title>Replay</title>
      <style>
        html, body {
          margin: 0;
          height: 100%;
          width: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
        }
      </style>
    </head>
    <body>
    <script>
      window.onerror = e => { window.webkit.messageHandlers.error.postMessage(e.message || e); };
    
      \(replayRenderCanvasJsString)
      renderCanvas.run();
    </script>
    </body>
    </html>
"""

let replayRenderCanvasJsString = """
var renderCanvas=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";function i(e){var t,n,i;return{x:e.x||0,y:e.y||0,rotation:e.rotation||0,opacity:Math.min(1,Math.max(0,null!==(t=e.opacity)&&void 0!==t?t:1)),scaleX:null!==(n=e.scaleX)&&void 0!==n?n:1,scaleY:null!==(i=e.scaleY)&&void 0!==i?i:1,anchorX:e.anchorX||0,anchorY:e.anchorY||0,mask:e.mask||null}}function r(e,t,n,o,a,d,l,u,h,p){const f=i(t);f.opacity*=u;const{nativeSpriteMap:g,nativeSpriteUtils:m}=p,w=e=>{const t=o(e);return function(e){const t=Math.PI/180,n=-(e.rotation||0)*t;return({x:t,y:i})=>{const r=t-e.x,o=i-e.y,s=r*Math.cos(n)+o*Math.sin(n),a=-r*Math.sin(n)+o*Math.cos(n),c=s/e.scaleX,d=a/e.scaleY;return{x:c+e.anchorX,y:d+e.anchorY}}}(f)(t)},v=n(w),y=e.getSprites(t,v,a,d,l),P=[],M=y.map(t=>{if(!t)return t;if("native"===t.type){P.push(t.props.id);const n=g[t.name];if(!n)throw Error(`Cannot find Native Sprite "${t.name}"`);let i=e.childContainers[t.props.id];return i&&"native"===i.type||(i={type:"native",state:n.create({props:t.props,parentGlobalId:h,getState:()=>i.state,updateState:e=>{i.state={...i.state,...e}},utils:m}),cleanup:n.cleanup},e.childContainers[t.props.id]=i),i.state=n.loop({props:t.props,state:i.state,parentGlobalId:h,utils:m}),m.didResize=!1,null}if("custom"===t.type){P.push(t.props.id);let i=!1,o=e.childContainers[t.props.id];return o&&"custom"===o.type||(i=!0,o=s(t,v,e.prevTime),e.childContainers[t.props.id]=o),r(o,t.props,n,w,i,d,l,f.opacity,`${h}--${t.props.id}`,p)}return t}).filter(c),T=e=>{Object.keys(e).forEach(t=>{if(!P.includes(t)){const n=e[t];"native"===n.type?n.cleanup({state:n.state,parentGlobalId:h}):T(n.childContainers),delete e[t]}})};return T(e.childContainers),{id:t.id,baseProps:f,textures:M}}n.r(t),n.d(t,"run",(function(){return I}));const o=1/60*1e3;function s(e,t,n){const{spriteObj:i,props:r}=e,o=[],s=e=>{o.push(e)};let a;return i.init&&(a=i.init({props:r,device:t,updateState:s})),{type:"custom",state:a,childContainers:{},prevTime:n,currentLag:0,getSprites(e,t,n,r,a){const c=()=>{this.state=o.reduce((e,t)=>t(e),this.state),o.length=0};c(),!n&&i.loop&&(this.state=i.loop({props:e,state:this.state,device:t,updateState:s})),c();let d=i[r];d||(d="renderPXL"===r&&i.renderXL?i.renderXL:i.render);const l=d({props:e,state:this.state,device:t,updateState:s,extrapolateFactor:a});return c(),l}}}function a(e,t){const n=e.deviceHeight>e.deviceWidth;let i,r=!1;"portrait"in t?(i=n?t.portrait:t.landscape,r=!0):i=t;return i.minHeightXL&&e.deviceHeight>=i.minHeightXL||i.minWidthXL&&e.deviceWidth>=i.minWidthXL?r&&n?"renderPXL":"renderXL":r&&n?"renderP":"render"}function c(e){return null!==e}let d={keysDown:{},keysJustPressed:{},pointer:{pressed:!1,numberPressed:0,justPressed:!1,justReleased:!1,x:0,y:0}},l=[];function u(e){return function(e,t){const n=e(t.pointer);return{...t,pointer:{...t.pointer,x:n.x,y:n.y}}}(e,d)}function h(e){["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "].includes(e.key)&&!(e.target instanceof HTMLTextAreaElement||e.target instanceof HTMLInputElement)&&e.preventDefault(),d.keysDown[e.key]=!0,d.keysJustPressed[e.key]=!0}function p(e){delete d.keysDown[e.key]}function f(e,t,n){l.includes(n)||(l=[...l,n]),d.pointer.pressed=!0,d.pointer.numberPressed=l.length,d.pointer.justPressed=!0,d.pointer.x=e,d.pointer.y=t}function g(e,t){d.pointer.x=e,d.pointer.y=t}function m(e,t,n){l=l.filter(e=>e!==n),0===l.length&&(d.pointer.justPressed=!1,d.pointer.pressed=!1),d.pointer.numberPressed=l.length,d.pointer.justReleased=!0,d.pointer.x=e,d.pointer.y=t}function w(e){l=l.filter(t=>t!==e),d.pointer.numberPressed=l.length,0===l.length&&(d.pointer.justPressed=!1,d.pointer.pressed=!1)}function v(){d={keysDown:d.keysDown,keysJustPressed:{},pointer:{...d.pointer,justPressed:!1,justReleased:!1}}}function y(e,{width:t,height:n,widthMargin:i,heightMargin:r,deviceWidth:o,deviceHeight:s},a,c){e.save();const d=Math.min(o/t,s/n),l=t+2*i,u=n+2*r;return e.translate(o/2,s/2),e.scale(d,d),{scale:d,render:t=>{e.clearRect(-o/2/d,-s/2/d,o/d,s/d),e.fillStyle="white",e.fillRect(-l/2,-u/2,l,u),function e(t,n,i,r){const{baseProps:o,textures:s}=t;n.save(),M(n,o),s.forEach(t=>{if("type"in t){const e=T(n);return n.save(),M(n,t.props,o.opacity),function(e,t,n,i){switch(e.type){case"text":return t.text(e.props.font||i,e.props.text,e.props.align,e.props.color),0;case"circle":return t.circle(e.props.radius,e.props.color),0;case"rectangle":return t.rectangle(e.props.width,e.props.height,e.props.color),0;case"line":return t.line(e.props.path,e.props.thickness,e.props.color),0;case"image":const r=n[e.props.fileName];if(!r)throw Error(`Cannot find image file "${e.props.fileName}"`);return t.image(r,e.props.width,e.props.height),0;case"spriteSheet":t.spriteSheet(n[e.props.fileName],e.props.columns,e.props.rows,e.props.index,e.props.width,e.props.height)}}(t,e,i,r),void n.restore()}e(t,n,i,r)}),n.restore()}(t,e,a,c)}}}const P=Math.PI/180,M=(e,t,n=1)=>{const{x:i,y:r,rotation:o,scaleX:s,scaleY:a,anchorX:c,anchorY:d,opacity:l}=t;e.translate(i,-r),e.rotate(o*P),e.scale(s,a),e.translate(-c,d),e.globalAlpha=l*n,function(e,t){if(!t)return 0;switch(t.type){case"lineMask":{const[[n,i],...r]=t.path;return e.beginPath(),e.moveTo(n,-i),r.forEach(([t,n])=>{e.lineTo(t,-n)}),e.clip(),0}case"circleMask":return e.beginPath(),e.arc(t.x,-t.y,Math.round(t.radius),0,2*Math.PI),e.clip(),0;case"rectangleMask":e.beginPath(),e.rect(t.x-t.width/2,-t.y-t.height/2,t.width,t.height),e.clip()}}(e,t.mask)};const T=e=>({circle(t,n){e.beginPath(),e.arc(0,0,Math.round(t),0,2*Math.PI),e.fillStyle=n,e.fill(),e.closePath()},rectangle(t,n,i){e.fillStyle=i,e.fillRect(-t/2,-n/2,t,n),e.closePath()},line(t,n,i){if(t.length<2)return;const[[r,o],...s]=t;e.strokeStyle=i,e.lineWidth=n,e.beginPath(),e.moveTo(r,-o),s.forEach(([t,n])=>{e.lineTo(t,-n)}),e.stroke()},text(t,n,i,r){const o=`${t.size}px ${t.name}`;e.font=o,e.textBaseline="middle",e.textAlign=i,e.fillStyle=r,e.fillText(n,0,0)},image(t,n,i){e.drawImage(t,-n/2,-i/2,n,i)},spriteSheet(t,n,i,r,o,s){const a=t.width/n,c=t.height/i,d=r%n,l=Math.floor(r/n)%i;e.drawImage(t,d*a,l*c,a,c,-o/2,-s/2,o,s)}});let b;function x(e,t,n,i){let r;if("portrait"in i){r=t>e?i.portrait:i.landscape}else r=i;const{width:o,height:s,maxWidthMargin:a=0,maxHeightMargin:c=0}=r;if("game-coords"===n)return{width:o,height:s,widthMargin:0,heightMargin:0,deviceWidth:o,deviceHeight:s};const d=o/s;if(d>e/t){const n=e,i=n/d,r=i/s*c,a=Math.min(t,i+2*r);return{width:o,height:s,widthMargin:0,heightMargin:(a-i)/2*(s/i),deviceWidth:n,deviceHeight:a}}{const n=t,i=n*d,r=i/o*a,c=Math.min(e,i+2*r);return{width:o,height:s,widthMargin:(c-i)/2*(o/i),heightMargin:0,deviceWidth:c,deviceHeight:n}}}function S(){const e={};return{start:(t,n)=>{const i=window.setTimeout(()=>{delete e[r],t()},n),r=String(i);return e[r]={timeoutId:i,callback:t,timeStartedMs:Date.now(),timeRemainingMs:n,isPaused:!1},r},pause:t=>{const n=e[t];if(!n||n.isPaused)return;const i=Date.now()-n.timeStartedMs;n.timeRemainingMs-=i,n.isPaused=!0,window.clearTimeout(n.timeoutId)},resume:t=>{const n=e[t];if(!n||!n.isPaused)return;n.timeStartedMs=Date.now(),n.isPaused=!1;const i=window.setTimeout(()=>{delete e[t],n.callback()},n.timeRemainingMs);n.timeoutId=i},cancel:t=>{const n=e[t];n&&(window.clearTimeout(n.timeoutId),delete e[t])}}}function L(e,t){return n=>{const{data:i,mutPlayState:r}=t[n];return{getPosition:()=>r?r.isPaused?r.alreadyPlayedTime:e.currentTime-r.startTime:0,play:(o,s=!1)=>{var a;const c=e.createBufferSource();c.buffer=i,c.connect(e.destination);const d=null!==(a=null!=o?o:null==r?void 0:r.alreadyPlayedTime)&&void 0!==a?a:0;c.start(void 0,d),c.loop=s,c.onended=()=>{var e;!1===(null===(e=t[n].mutPlayState)||void 0===e?void 0:e.isPaused)&&delete t[n].mutPlayState};r&&!r.isPaused||(t[n].mutPlayState={startTime:e.currentTime-d,sample:c,alreadyPlayedTime:d,isPaused:!1})},pause:()=>{r&&!r.isPaused&&(r.sample.stop(),t[n].mutPlayState={...r,alreadyPlayedTime:e.currentTime-r.startTime,isPaused:!0})}}}}function E(){if("ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch)return!0;return window.matchMedia("(touch-enabled),(-webkit-touch-enabled),(-moz-touch-enabled),(-o-touch-enabled),(-ms-touch-enabled)").matches}const k={name:"sans-serif",size:12};function X(e,{loadingTextures:t=[],assets:n={},dimensions:c="game-coords",nativeSpriteMap:d={},canvas:l,windowSize:u}){var P;const M=l||document.createElement("canvas");l||document.body.appendChild(M);const T=window.PointerEvent?"pointerdown":"touchstart",S=window.PointerEvent?"pointermove":"touchmove",L=window.PointerEvent?"pointerup":"touchend",E=window.PointerEvent?"pointercancel":"touchcancel",X=M.getContext("2d",{alpha:!1}),I=new(window.AudioContext||window.webkitAudioContext);let O=!0;let C,D,Y,H,z,R;document.addEventListener("keydown",e=>{O&&h(e)},!1),document.addEventListener("keyup",e=>{O&&p(e)},!1),window.addEventListener("resize",A,!1),document.addEventListener("contextmenu",e=>{e.preventDefault()});const W={didResize:!1,scale:1,gameXToPlatformX:e=>e,gameYToPlatformY:e=>e};function A(t){if(C&&(X.restore(),document.removeEventListener(T,D),document.removeEventListener(S,Y),document.removeEventListener(L,H),document.removeEventListener(E,z),!0===t))return;const n=function(e,t,n,i){const r=x(e,t,n,i);return b=r,r}((null==u?void 0:u.width)||window.innerWidth,(null==u?void 0:u.height)||window.innerHeight,c,e.props.size);M.width=n.deviceWidth,M.height=n.deviceHeight;const i=e.props.defaultFont||k,r=y(X,n,F,i);R=r.scale,$.ref=r.render,W.gameXToPlatformX=(({canvasOffsetLeft:e,widthMargin:t,scale:n,width:i})=>r=>e+n*(r+i/2+t))({canvasOffsetLeft:M.offsetLeft,width:n.width,widthMargin:n.widthMargin,scale:R}),W.gameYToPlatformY=(({canvasOffsetTop:e,heightMargin:t,scale:n,height:i})=>r=>e-n*(r-i/2-t))({canvasOffsetTop:M.offsetTop,height:n.height,heightMargin:n.heightMargin,scale:R}),W.didResize=!0,W.scale=R;const o=(({canvasOffsetLeft:e,widthMargin:t,scale:n,width:i})=>r=>(r.clientX-e)/n-t-i/2)({canvasOffsetLeft:M.offsetLeft,width:n.width,widthMargin:n.widthMargin,scale:R}),s=(({canvasOffsetTop:e,heightMargin:t,scale:n,height:i})=>r=>-(r.clientY-e)/n+t+i/2)({canvasOffsetTop:M.offsetTop,height:n.height,heightMargin:n.heightMargin,scale:R}),a=(e,t)=>e>n.width/2+n.widthMargin||e<-n.width/2-n.widthMargin||t>n.height/2+n.heightMargin||t<-n.height/2-n.heightMargin;D=e=>{if("changedTouches"in e){O=!1;for(let t=0;t<e.changedTouches.length;t++){const n=e.changedTouches[t],i=o({clientX:n.screenX}),r=s({clientY:n.screenY});a(i,r)||(O=!0,f(i,r,n.identifier))}return}const t=o(e),n=s(e);a(t,n)?O=!1:(O=!0,f(t,n,e.pointerId))},Y=e=>{if("changedTouches"in e){for(let t=0;t<e.changedTouches.length;t++){const n=e.changedTouches[t],i=o({clientX:n.screenX}),r=s({clientY:n.screenY});a(i,r)||g(i,r)}return}const t=o(e),n=s(e);a(t,n)||g(t,n)},H=e=>{if("changedTouches"in e){for(let t=0;t<e.changedTouches.length;t++){const n=e.changedTouches[t],i=o({clientX:n.screenX}),r=s({clientY:n.screenY});a(i,r)?w(n.identifier):m(i,r,n.identifier)}return}const t=o(e),n=s(e);a(t,n)?w(e.pointerId):m(t,n,e.pointerId)},z=e=>{if("changedTouches"in e)for(let t=0;t<e.changedTouches.length;t++)w(e.changedTouches[t].identifier);else w(e.pointerId)},document.addEventListener(T,D,!1),document.addEventListener(S,Y,!1),document.addEventListener(L,H,!1),document.addEventListener(E,z,!1),C=n}const N={},F={},G={getGetDevice:j(I,N,x((null==u?void 0:u.width)||window.innerWidth,(null==u?void 0:u.height)||window.innerHeight,c,e.props.size))},$={ref:null};A();let _=!1;null===(P=$.ref)||void 0===P||P.call($,{id:"Loading",baseProps:i({}),textures:t});return{cleanup:function(){M.width=M.width,l||document.body.removeChild(M),_=!0,document.removeEventListener("keydown",h,!1),document.removeEventListener("keyup",p,!1),window.removeEventListener("resize",A,!1),A(!0)},loadPromise:(async()=>{const e=[];(n.audioFileNames||[]).forEach(t=>{e.push(async function(e,t){const n=await fetch(t),i=await n.arrayBuffer();return await new Promise((t,n)=>{e.decodeAudioData(i,t,n)})}(I,t).then(e=>{N[t]={data:e}}))}),(n.imageFileNames||[]).forEach(t=>{F[t]=new Image,e.push(new Promise((e,n)=>{F[t].addEventListener("load",e),F[t].addEventListener("error",n),F[t].src=t}))}),await Promise.all(e)})().then(()=>{const t=()=>{document.removeEventListener("keydown",t,!1),document.removeEventListener(T,t,!1),"suspended"===I.state&&I.resume()};document.addEventListener("keydown",t,!1),document.addEventListener(T,t,!1);const{initTextures:n,getNextFrameTextures:i}=function(e,t,n,i){const c=({x:e,y:t})=>({x:e,y:t}),d=e.getGetDevice(),l=d(c),u=s(n,d(c),0),h=i||n.props.size,p=a(l.size,h);let f=0,g=0,m=r(u,n.props,d,c,!0,p,0,1,n.props.id,t);return{initTextures:m,getNextFrameTextures(i,s){const d=i-f;for(f=i,g+=d;g>=o;){g-=o;const i=g/o,d=e.getGetDevice(),l=a(d(c).size,h);m=r(u,n.props,d,c,!1,l,i,1,n.props.id,t),s()}return m}}}(G,{nativeSpriteMap:d,nativeSpriteUtils:W},e);let c=null;!function e(t){var n;null===(n=$.ref)||void 0===n||n.call($,t),window.requestAnimationFrame(t=>{_||(null===c&&(c=t-1/60),e(i(t-c,v)))})}(n)}),audioElements:N,audioContext:I}}function j(e,t,n){const i={isTouchScreen:E(),log:console.log,random:Math.random,timer:S(),audio:L(e,t),network:{get:(e,t)=>{fetch(e).then(e=>e.json()).then(t)},post:(e,t,n)=>{fetch(e,{method:"POST",body:JSON.stringify(t)}).then(e=>e.json()).then(n)},put:(e,t,n)=>{fetch(e,{method:"PUT",body:JSON.stringify(t)}).then(e=>e.json()).then(n)},delete:(e,t)=>{fetch(e,{method:"DELETE"}).then(e=>e.json()).then(t)}},storage:{getStore:()=>{var e;const t={};for(let n=0;n<localStorage.length;n++){const i=localStorage.key(n);i&&(t[i]=null!==(e=localStorage.getItem(i))&&void 0!==e?e:void 0)}return t},setStore:e=>{Object.entries(e).forEach(([e,t])=>{void 0===t?localStorage.removeItem(e):localStorage.setItem(e,t)})}},alert:{ok:(e,t)=>{alert(e),null==t||t()},okCancel:(e,t)=>{t(confirm(e))}},clipboard:{copy:(e,t)=>{navigator.clipboard?navigator.clipboard.writeText(e).then(()=>{t()}).catch(e=>{t(e)}):t(new Error(window.isSecureContext?"Couldn't access clipboard":"Clipboard only available on HTTPS or localhost"))}}};return()=>{const e={...i,size:b||n,now:()=>new Date};return t=>({...e,inputs:u(t)})}}function I(){const{loadPromise:e}=X(game.Game(game.gameProps),game.options);e.then(()=>{webkit.messageHandlers.didLoad.postMessage("")})}console.log=e=>{webkit.messageHandlers.consoleLog.postMessage(e)}}]);
"""
