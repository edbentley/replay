// Swift 5.3 will support Package resources like a JS file
// https://github.com/apple/swift-evolution/blob/master/proposals/0271-package-manager-resources.md
// Until then, we'll just copy renderCanvas.js as a string here

let replayRenderCanvasHtmlString = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
      <title>Replay</title>
      <style>
        html, body {
          margin: 0;
          height: 100%;
          width: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
        }
      </style>
    </head>
    <body>
    <script>
      window.onerror = e => { window.webkit.messageHandlers.error.postMessage(e.message || e); };
    
      \(replayRenderCanvasJsString)
      renderCanvas.run();
    </script>
    </body>
    </html>
"""

let replayRenderCanvasJsString = """
var renderCanvas=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";function i(e){var t,n,i;return{x:e.x||0,y:e.y||0,rotation:e.rotation||0,opacity:Math.min(1,Math.max(0,null!==(t=e.opacity)&&void 0!==t?t:1)),scaleX:null!==(n=e.scaleX)&&void 0!==n?n:1,scaleY:null!==(i=e.scaleY)&&void 0!==i?i:1,anchorX:e.anchorX||0,anchorY:e.anchorY||0,mask:e.mask||null}}function r(e,t,n,o,a,l,u,p,h,f){const m=i(t);m.opacity*=p;const{nativeSpriteMap:g,nativeSpriteUtils:v}=f,w=e=>{const t=o(e);return function(e){const t=Math.PI/180,n=-(e.rotation||0)*t;return({x:t,y:i})=>{const r=t-e.x,o=i-e.y,s=r*Math.cos(n)+o*Math.sin(n),a=-r*Math.sin(n)+o*Math.cos(n),c=s/e.scaleX,d=a/e.scaleY;return{x:c+e.anchorX,y:d+e.anchorY}}}(m)(t)},y=n(w),P=e.getSprites(t,y,a,l,u),T=new Set(e.prevChildIds),M=[],b=P.map((function(t){if(!t)return t;if("native"===t.type){M.push(t.props.id),T.delete(t.props.id);const n=g[t.name];if(!n)throw Error(`Cannot find Native Sprite "${t.name}"`);let i=e.childContainers[t.props.id];if(!i||"native"!==i.type){const r={type:"native",state:n.create({props:t.props,parentGlobalId:h,getState:()=>r.state,updateState:e=>{r.state={...r.state,...e}},utils:v}),cleanup:n.cleanup};e.childContainers[t.props.id]=r,i=r}return i.state=n.loop({props:t.props,state:i.state,parentGlobalId:h,utils:v}),null}if("pure"===t.type){M.push(t.props.id),T.delete(t.props.id);let n=e.childContainers[t.props.id];return n&&"pure"===n.type||(n=c(t),e.childContainers[t.props.id]=n),function e(t,n,r,o,s,a){const l=i(n);l.opacity*=a;const u=t.getSprites(n,r,o,s);if("cachedTextures"===u.type)return{id:n.id,baseProps:l,textures:u.textures};const{sprites:p}=u,h=new Set(t.prevChildIds),f=[],m=p.map((function(n){if(!n)return n;if("pure"===n.type){f.push(n.props.id),h.delete(n.props.id);let i=t.childContainers[n.props.id];return i&&"pure"===i.type||(i=c(n),t.childContainers[n.props.id]=i),e(i,n.props,r,o,s,l.opacity)}return n})).filter(d);return h.forEach(e=>{delete t.childContainers[e]}),t.cache=m,t.prevChildIds=f,{id:n.id,baseProps:l,textures:m}}(n,t.props,y.size,v.didResize,l,m.opacity)}if("custom"===t.type){M.push(t.props.id),T.delete(t.props.id);let i=!1,o=e.childContainers[t.props.id];return o&&"custom"===o.type||(i=!0,o=s(t,y,e.prevTime),e.childContainers[t.props.id]=o),r(o,t.props,n,w,i,l,u,m.opacity,`${h}--${t.props.id}`,f)}return t})).filter(d);return v.didResize=!1,T.forEach(t=>{const n=e=>{Object.values(e).forEach(e=>{"custom"===e.type?n(Object.values(e.childContainers)):"native"===e.type&&e.cleanup({state:e.state,parentGlobalId:h})})},i=e.childContainers[t];n([i]),delete e.childContainers[t]}),e.prevChildIds=M,{id:t.id,baseProps:m,textures:b}}n.r(t),n.d(t,"run",(function(){return j}));const o=1/60*1e3;function s(e,t,n){const{spriteObj:i,props:r}=e,o=[],s=e=>{o.push(e)};let a;return i.init&&(a=i.init({props:r,device:t,updateState:s})),{type:"custom",state:a,childContainers:{},prevChildIds:[],prevTime:n,currentLag:0,getSprites(e,t,n,r,a){const c=()=>{this.state=o.reduce((e,t)=>t(e),this.state),o.length=0};c(),!n&&i.loop&&(this.state=i.loop({props:e,state:this.state,device:t,updateState:s})),c();let d=i[r];d||(d="renderPXL"===r&&i.renderXL?i.renderXL:i.render);const l=d({props:e,state:this.state,device:t,updateState:s,extrapolateFactor:a});return c(),l}}}function a(e,t){const n=e.deviceHeight>e.deviceWidth;let i,r=!1;"portrait"in t?(i=n?t.portrait:t.landscape,r=!0):i=t;return i.minHeightXL&&e.deviceHeight>=i.minHeightXL||i.minWidthXL&&e.deviceWidth>=i.minWidthXL?r&&n?"renderPXL":"renderXL":r&&n?"renderP":"render"}function c(e){const{spriteObj:t}=e;return{type:"pure",childContainers:{},prevChildIds:[],getSprites(e,n,i,r){let o=t[r];return o||(o="renderPXL"===r&&t.renderXL?t.renderXL:t.render),this.prevProps&&this.cache&&!t.shouldRerender(this.prevProps,e)&&!i?(this.prevProps=e,{type:"cachedTextures",textures:this.cache}):(this.prevProps=e,{type:"pureSprites",sprites:o({props:e,size:n})})}}}function d(e){return null!==e}let l={keysDown:{},keysJustPressed:{},pointer:{pressed:!1,numberPressed:0,justPressed:!1,justReleased:!1,x:0,y:0}},u=[];function p(e){return function(e,t){const n=e(t.pointer);return{...t,pointer:{...t.pointer,x:n.x,y:n.y}}}(e,l)}function h(e){["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "].includes(e.key)&&!(e.target instanceof HTMLTextAreaElement||e.target instanceof HTMLInputElement)&&e.preventDefault(),l.keysDown[e.key]=!0,l.keysJustPressed[e.key]=!0}function f(e){delete l.keysDown[e.key]}function m(e,t,n){u.includes(n)||(u=[...u,n]),l.pointer.pressed=!0,l.pointer.numberPressed=u.length,l.pointer.justPressed=!0,l.pointer.x=e,l.pointer.y=t}function g(e,t){l.pointer.x=e,l.pointer.y=t}function v(e,t,n){u=u.filter(e=>e!==n),0===u.length&&(l.pointer.justPressed=!1,l.pointer.pressed=!1),l.pointer.numberPressed=u.length,l.pointer.justReleased=!0,l.pointer.x=e,l.pointer.y=t}function w(e){u=u.filter(t=>t!==e),l.pointer.numberPressed=u.length,0===u.length&&(l.pointer.justPressed=!1,l.pointer.pressed=!1)}function y(){l={keysDown:l.keysDown,keysJustPressed:{},pointer:{...l.pointer,justPressed:!1,justReleased:!1}}}function P(e,{width:t,height:n,widthMargin:i,heightMargin:r,deviceWidth:o,deviceHeight:s},a,c){e.save();const d=Math.min(o/t,s/n),l=t+2*i,u=n+2*r;return e.translate(o/2,s/2),e.scale(d,d),{scale:d,render:t=>{e.clearRect(-o/2/d,-s/2/d,o/d,s/d),e.fillStyle="white",e.fillRect(-l/2,-u/2,l,u),function e(t,n,i,r){const{baseProps:o,textures:s}=t;n.save(),M(n,o),s.forEach(t=>{if("type"in t){const e=b(n);return n.save(),M(n,t.props,o.opacity),function(e,t,n,i){switch(e.type){case"text":return t.text(e.props.font||i,e.props.text,e.props.align,e.props.color),0;case"circle":return t.circle(e.props.radius,e.props.color),0;case"rectangle":return t.rectangle(e.props.width,e.props.height,e.props.color),0;case"line":return t.line(e.props.path,e.props.thickness,e.props.color,e.props.fillColor,e.props.lineCap),0;case"image":const r=n[e.props.fileName];if(!r)throw Error(`Cannot find image file "${e.props.fileName}"`);return t.image(r,e.props.width,e.props.height),0;case"spriteSheet":t.spriteSheet(n[e.props.fileName],e.props.columns,e.props.rows,e.props.index,e.props.width,e.props.height)}}(t,e,i,r),void n.restore()}e(t,n,i,r)}),n.restore()}(t,e,a,c)}}}const T=Math.PI/180,M=(e,t,n=1)=>{const{x:i,y:r,rotation:o,scaleX:s,scaleY:a,anchorX:c,anchorY:d,opacity:l}=t;e.translate(i,-r),e.rotate(o*T),e.scale(s,a),e.translate(-c,d),e.globalAlpha=l*n,function(e,t){if(!t)return 0;switch(t.type){case"lineMask":{const[[n,i],...r]=t.path;return e.beginPath(),e.moveTo(n,-i),r.forEach(([t,n])=>{e.lineTo(t,-n)}),e.clip(),0}case"circleMask":return e.beginPath(),e.arc(t.x,-t.y,Math.round(t.radius),0,2*Math.PI),e.clip(),0;case"rectangleMask":e.beginPath(),e.rect(t.x-t.width/2,-t.y-t.height/2,t.width,t.height),e.clip()}}(e,t.mask)};const b=e=>({circle(t,n){e.beginPath(),e.arc(0,0,Math.round(t),0,2*Math.PI),e.fillStyle=n,e.fill(),e.closePath()},rectangle(t,n,i){e.fillStyle=i,e.fillRect(-t/2,-n/2,t,n),e.closePath()},line(t,n,i,r,o){if(t.length<2)return;const[[s,a],...c]=t;e.beginPath(),e.moveTo(s,-a),c.forEach(([t,n])=>{e.lineTo(t,-n)}),r&&(e.fillStyle=r,e.fill()),i&&(e.strokeStyle=i,e.lineWidth=n,e.lineCap=o,e.stroke())},text(t,n,i,r){const o=`${t.size}px ${t.name}`;e.font=o,e.textBaseline="middle",e.textAlign=i,e.fillStyle=r,e.fillText(n,0,0)},image(t,n,i){e.drawImage(t,-n/2,-i/2,n,i)},spriteSheet(t,n,i,r,o,s){const a=t.width/n,c=t.height/i,d=r%n,l=Math.floor(r/n)%i;e.drawImage(t,d*a,l*c,a,c,-o/2,-s/2,o,s)}});let x;function S(e,t,n,i){let r;if("portrait"in i){r=t>e?i.portrait:i.landscape}else r=i;const{width:o,height:s,maxWidthMargin:a=0,maxHeightMargin:c=0}=r;if("game-coords"===n)return{width:o,height:s,widthMargin:0,heightMargin:0,deviceWidth:o,deviceHeight:s};const d=o/s;if(d>e/t){const n=e,i=n/d,r=i/s*c,a=Math.min(t,i+2*r);return{width:o,height:s,widthMargin:0,heightMargin:(a-i)/2*(s/i),deviceWidth:n,deviceHeight:a}}{const n=t,i=n*d,r=i/o*a,c=Math.min(e,i+2*r);return{width:o,height:s,widthMargin:(c-i)/2*(o/i),heightMargin:0,deviceWidth:c,deviceHeight:n}}}function L(){const e={};return{start:(t,n)=>{const i=window.setTimeout(()=>{delete e[r],t()},n),r=String(i);return e[r]={timeoutId:i,callback:t,timeStartedMs:Date.now(),timeRemainingMs:n,isPaused:!1},r},pause:t=>{const n=e[t];if(!n||n.isPaused)return;const i=Date.now()-n.timeStartedMs;n.timeRemainingMs-=i,n.isPaused=!0,window.clearTimeout(n.timeoutId)},resume:t=>{const n=e[t];if(!n||!n.isPaused)return;n.timeStartedMs=Date.now(),n.isPaused=!1;const i=window.setTimeout(()=>{delete e[t],n.callback()},n.timeRemainingMs);n.timeoutId=i},cancel:t=>{const n=e[t];n&&(window.clearTimeout(n.timeoutId),delete e[t])}}}function E(e,t){return n=>{const{data:i,mutPlayState:r}=t[n];return{getPosition:()=>r?r.isPaused?r.alreadyPlayedTime:e.currentTime-r.startTime:0,play:(o,s=!1)=>{var a;const c=e.createBufferSource();c.buffer=i,c.connect(e.destination);const d=null!==(a=null!=o?o:null==r?void 0:r.alreadyPlayedTime)&&void 0!==a?a:0;c.start(void 0,d),c.loop=s,c.onended=()=>{var e;!1===(null===(e=t[n].mutPlayState)||void 0===e?void 0:e.isPaused)&&delete t[n].mutPlayState};r&&!r.isPaused||(t[n].mutPlayState={startTime:e.currentTime-d,sample:c,alreadyPlayedTime:d,isPaused:!1})},pause:()=>{r&&!r.isPaused&&(r.sample.stop(),t[n].mutPlayState={...r,alreadyPlayedTime:e.currentTime-r.startTime,isPaused:!0})}}}}function k(){if("ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch)return!0;return window.matchMedia("(touch-enabled),(-webkit-touch-enabled),(-moz-touch-enabled),(-o-touch-enabled),(-ms-touch-enabled)").matches}const C={name:"sans-serif",size:12};function X(e,{loadingTextures:t=[],assets:n={},dimensions:c="game-coords",nativeSpriteMap:d={},canvas:l,windowSize:u}){var p;const T=l||document.createElement("canvas");l||document.body.appendChild(T);const M=window.PointerEvent?"pointerdown":"touchstart",b=window.PointerEvent?"pointermove":"touchmove",L=window.PointerEvent?"pointerup":"touchend",E=window.PointerEvent?"pointercancel":"touchcancel",k=T.getContext("2d",{alpha:!1}),X=new(window.AudioContext||window.webkitAudioContext);let j=!0,O=!0,D=0,Y=!1,z=0,H=0;const R=()=>{document.hidden&&O&&(z=D,X.suspend()),document.hidden||O||(Y=!0,setTimeout(()=>{X.suspend(),setTimeout(()=>{X.resume()},75)},75)),O=!document.hidden};let W,A,N,F,G,$;document.addEventListener("keydown",e=>{j&&h(e)},!1),document.addEventListener("keyup",e=>{j&&f(e)},!1),document.addEventListener("visibilitychange",R,!1),window.addEventListener("resize",J,!1),document.addEventListener("contextmenu",e=>{e.preventDefault()});const _={didResize:!1,scale:1,gameXToPlatformX:e=>e,gameYToPlatformY:e=>e};function J(t){if(W&&(k.restore(),document.removeEventListener(M,A),document.removeEventListener(b,N),document.removeEventListener(L,F),document.removeEventListener(E,G),!0===t))return;const n=function(e,t,n,i){const r=S(e,t,n,i);return x=r,r}((null==u?void 0:u.width)||window.innerWidth,(null==u?void 0:u.height)||window.innerHeight,c,e.props.size);T.width=n.deviceWidth,T.height=n.deviceHeight;const i=e.props.defaultFont||C,r=P(k,n,B,i);$=r.scale,K.ref=r.render,_.gameXToPlatformX=(({canvasOffsetLeft:e,widthMargin:t,scale:n,width:i})=>r=>e+n*(r+i/2+t))({canvasOffsetLeft:T.offsetLeft,width:n.width,widthMargin:n.widthMargin,scale:$}),_.gameYToPlatformY=(({canvasOffsetTop:e,heightMargin:t,scale:n,height:i})=>r=>e-n*(r-i/2-t))({canvasOffsetTop:T.offsetTop,height:n.height,heightMargin:n.heightMargin,scale:$}),_.didResize=!0,_.scale=$;const o=(({canvasOffsetLeft:e,widthMargin:t,scale:n,width:i})=>r=>(r.clientX-e)/n-t-i/2)({canvasOffsetLeft:T.offsetLeft,width:n.width,widthMargin:n.widthMargin,scale:$}),s=(({canvasOffsetTop:e,heightMargin:t,scale:n,height:i})=>r=>-(r.clientY-e)/n+t+i/2)({canvasOffsetTop:T.offsetTop,height:n.height,heightMargin:n.heightMargin,scale:$}),a=(e,t)=>e>n.width/2+n.widthMargin||e<-n.width/2-n.widthMargin||t>n.height/2+n.heightMargin||t<-n.height/2-n.heightMargin;A=e=>{if("changedTouches"in e){j=!1;for(let t=0;t<e.changedTouches.length;t++){const n=e.changedTouches[t],i=o({clientX:n.screenX}),r=s({clientY:n.screenY});a(i,r)||(j=!0,m(i,r,n.identifier))}return}const t=o(e),n=s(e);a(t,n)?j=!1:(j=!0,m(t,n,e.pointerId))},N=e=>{if("changedTouches"in e){for(let t=0;t<e.changedTouches.length;t++){const n=e.changedTouches[t],i=o({clientX:n.screenX}),r=s({clientY:n.screenY});a(i,r)||g(i,r)}return}const t=o(e),n=s(e);a(t,n)||g(t,n)},F=e=>{if("changedTouches"in e){for(let t=0;t<e.changedTouches.length;t++){const n=e.changedTouches[t],i=o({clientX:n.screenX}),r=s({clientY:n.screenY});a(i,r)?w(n.identifier):v(i,r,n.identifier)}return}const t=o(e),n=s(e);a(t,n)?w(e.pointerId):v(t,n,e.pointerId)},G=e=>{if("changedTouches"in e)for(let t=0;t<e.changedTouches.length;t++)w(e.changedTouches[t].identifier);else w(e.pointerId)},document.addEventListener(M,A,!1),document.addEventListener(b,N,!1),document.addEventListener(L,F,!1),document.addEventListener(E,G,!1),W=n}const U={},B={},q={getGetDevice:I(X,U,S((null==u?void 0:u.width)||window.innerWidth,(null==u?void 0:u.height)||window.innerHeight,c,e.props.size))},K={ref:null};J();let Q=!1;null===(p=K.ref)||void 0===p||p.call(K,{id:"Loading",baseProps:i({}),textures:t});return{cleanup:function(){T.width=T.width,l||document.body.removeChild(T),Q=!0,document.removeEventListener("keydown",h,!1),document.removeEventListener("keyup",f,!1),document.removeEventListener("visibilitychange",R,!1),window.removeEventListener("resize",J,!1),J(!0)},loadPromise:(async()=>{const e=[];(n.audioFileNames||[]).forEach(t=>{e.push(async function(e,t){const n=await fetch(t),i=await n.arrayBuffer();return await new Promise((t,n)=>{e.decodeAudioData(i,t,n)})}(X,t).then(e=>{U[t]={data:e}}))}),(n.imageFileNames||[]).forEach(t=>{B[t]=new Image,e.push(new Promise((e,n)=>{B[t].addEventListener("load",e),B[t].addEventListener("error",n),B[t].src=t}))}),await Promise.all(e)})().then(()=>{const t=()=>{document.removeEventListener("keydown",t,!1),document.removeEventListener(M,t,!1),"suspended"===X.state&&X.resume()};document.addEventListener("keydown",t,!1),document.addEventListener(M,t,!1);const{initTextures:n,getNextFrameTextures:i}=function(e,t,n,i){const c=({x:e,y:t})=>({x:e,y:t}),d=e.getGetDevice(),l=d(c),u=s(n,d(c),0),p=i||n.props.size,h=a(l.size,p);let f=0,m=0,g=r(u,n.props,d,c,!0,h,0,1,n.props.id,t);return{initTextures:g,getNextFrameTextures(i,s){const d=i-f;for(f=i,m+=d;m>=o;){m-=o;const i=m/o,d=e.getGetDevice(),l=a(d(c).size,p);g=r(u,n.props,d,c,!1,l,i,1,n.props.id,t),s()}return g}}}(q,{nativeSpriteMap:d,nativeSpriteUtils:_},e);let c=null;!function e(t){var n;null===(n=K.ref)||void 0===n||n.call(K,t),window.requestAnimationFrame(t=>{Q||(null===c&&(c=t-1/60),Y&&(Y=!1,H+=t-z),D=t,e(i(t-c-H,y)))})}(n)}),audioElements:U,audioContext:X}}function I(e,t,n){const i={isTouchScreen:k(),log:console.log,random:Math.random,timer:L(),audio:E(e,t),network:{get:(e,t)=>{fetch(e).then(e=>e.json()).then(t)},post:(e,t,n)=>{fetch(e,{method:"POST",body:JSON.stringify(t)}).then(e=>e.json()).then(n)},put:(e,t,n)=>{fetch(e,{method:"PUT",body:JSON.stringify(t)}).then(e=>e.json()).then(n)},delete:(e,t)=>{fetch(e,{method:"DELETE"}).then(e=>e.json()).then(t)}},storage:{getStore:()=>{var e;const t={};for(let n=0;n<localStorage.length;n++){const i=localStorage.key(n);i&&(t[i]=null!==(e=localStorage.getItem(i))&&void 0!==e?e:void 0)}return t},setStore:e=>{Object.entries(e).forEach(([e,t])=>{void 0===t?localStorage.removeItem(e):localStorage.setItem(e,t)})}},alert:{ok:(e,t)=>{alert(e),null==t||t()},okCancel:(e,t)=>{t(confirm(e))}},clipboard:{copy:(e,t)=>{navigator.clipboard?navigator.clipboard.writeText(e).then(()=>{t()}).catch(e=>{t(e)}):t(new Error(window.isSecureContext?"Couldn't access clipboard":"Clipboard only available on HTTPS or localhost"))}}};return()=>{const e={...i,size:x||n,now:()=>new Date};return t=>({...e,inputs:p(t)})}}function j(){const{loadPromise:e}=X(game.Game(game.gameProps),game.options);e.then(()=>{webkit.messageHandlers.didLoad.postMessage("")})}console.log=e=>{webkit.messageHandlers.consoleLog.postMessage(e)}}]);
"""
