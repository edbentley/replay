(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{120:function(e,t,r){"use strict";r.r(t),r.d(t,"frontMatter",(function(){return i})),r.d(t,"metadata",(function(){return l})),r.d(t,"toc",(function(){return c})),r.d(t,"default",(function(){return p}));var a=r(3),n=r(7),o=(r(0),r(158)),i={slug:"javascriptcore-is-really-slow",title:"Replay v0.5: JavaScriptCore is really slow",author:"Ed Bentley",author_url:"https://twitter.com/edsbentley",author_image_url:"https://pbs.twimg.com/profile_images/1218565295771533313/SCcNRX9v_400x400.jpg"},l={permalink:"/blog/javascriptcore-is-really-slow",editUrl:"https://github.com/edbentley/replay/edit/master/website/blog/blog/2020-08-25-v0.50.md",source:"@site/blog/2020-08-25-v0.50.md",description:"Before v0.5 of the Replay game engine released last week, Replay was using JavaScriptCore to render a game on iOS.",date:"2020-08-25T00:00:00.000Z",tags:[],title:"Replay v0.5: JavaScriptCore is really slow",readingTime:1.905,truncated:!1,nextItem:{title:"Initial Launch",permalink:"/blog/launch"}},c=[],s={toc:c};function p(e){var t=e.components,r=Object(n.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},s,r,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"Before v0.5 of the Replay game engine released last week, Replay was using ",Object(o.b)("a",{parentName:"p",href:"https://nshipster.com/javascriptcore/"},"JavaScriptCore")," to render a game on iOS."),Object(o.b)("p",null,"When you write your Replay game in JavaScript, the Replay Swift package will load it into its own context using JavaScriptCore. From there it calls your ",Object(o.b)("inlineCode",{parentName:"p"},"loop")," and ",Object(o.b)("inlineCode",{parentName:"p"},"render")," methods and gets all the textures it needs to render as a big dictionary (converted from a JavaScript object)."),Object(o.b)("p",null,"This provided a lot of flexibility since all of the platform features (like rendering, audio and storage) could be done natively."),Object(o.b)("p",null,"However recent tests with a large number of Sprites has shown terrible lag on iOS. The strange thing was, if I played the same game through Safari on the same device, the performance was much better. CPU usage went from 100% down to 10%!"),Object(o.b)("p",null,"After doing some more research, including finding ",Object(o.b)("a",{parentName:"p",href:"https://www.lucidchart.com/techblog/2019/01/03/javascriptcore-10-months-later/"},"a great article on why this team migrated to WKWebView"),', I realised that using an embedded web view would be the only way to achieve great JavaScript performance on iOS. I really feel that all JavaScriptCore tutorials need a big red banner at the top of them warning "JavaScriptCore can be really slow!".'),Object(o.b)("p",null,"So why is JavaScriptCore so slow? Well, when it uses its JIT (Just-In-Time) compiler it's actually really fast. The JIT compiler can greatly speed up code which is executed multiple times (which certainly happens a lot in a game loop) - you can ",Object(o.b)("a",{parentName:"p",href:"http://somethingkindawierd.com/2015/10/profiling-javascript-in-javascriptcore.html"},"read more on that here"),"."),Object(o.b)("p",null,"But as mentioned in the previous articles, for various security reasons Apple doesn't enable the JIT compiler on iOS except on its own apps like Safari or embedded web views."),Object(o.b)("p",null,"So Replay v0.5 has completely refactored the Replay Swift package to just use a WKWebView. There ",Object(o.b)("em",{parentName:"p"},"is")," a way to execute JavaScript code on its own using a WKWebView, however its asynchronous nature made it impossible to interact with the core Replay API as it's designed now."),Object(o.b)("p",null,"Instead, it imports the ",Object(o.b)("inlineCode",{parentName:"p"},"@replay/web")," package and is essentially running your game as a webpage in Safari. Playing the same game that had 100% CPU usage in v0.4, v0.5 reduced it down to just 4% CPU usage."),Object(o.b)("p",null,"It's a shame JavaScriptCore has this limit on performance, but from the iOS player's point of view, the game plays the same and runs really fast!"))}p.isMDXComponent=!0},158:function(e,t,r){"use strict";r.d(t,"a",(function(){return u})),r.d(t,"b",(function(){return d}));var a=r(0),n=r.n(a);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function c(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var s=n.a.createContext({}),p=function(e){var t=n.a.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},u=function(e){var t=p(e.components);return n.a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.a.createElement(n.a.Fragment,{},t)}},b=n.a.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),u=p(r),b=a,d=u["".concat(i,".").concat(b)]||u[b]||m[b]||o;return r?n.a.createElement(d,l(l({ref:t},s),{},{components:r})):n.a.createElement(d,l({ref:t},s))}));function d(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,i=new Array(o);i[0]=b;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var s=2;s<o;s++)i[s]=r[s];return n.a.createElement.apply(null,i)}return n.a.createElement.apply(null,r)}b.displayName="MDXCreateElement"}}]);